var Tributes = [
    {
        "name":"香",
        "children":[
            {
                "name":"功德香", "price":20, "include":[],"swidth":400,"sheight":300,"width":200,"height":160,
                "src":"./assets/images/aburnjoss/tributes/joss/stick1_","extension":".png","frames":2,"frameRate":5
            },
            {
                "name":"平安香", "price":20, "include":[],"swidth":650,"sheight":488,"width":200,"height":160,
                "src":"./assets/images/aburnjoss/tributes/joss/stick2_","extension":".png","frames":2,"frameRate":5
            },
            {
                "name":"求财香", "price":20, "include":[],"swidth":650,"sheight":488,"width":200,"height":160,
                "src":"./assets/images/aburnjoss/tributes/joss/stick3_","extension":".png","frames":2,"frameRate":5
            },
            {
                "name":"檀香", "price":20, "include":[],"swidth":650,"sheight":488,"width":200,"height":160,
                "src":"./assets/images/aburnjoss/tributes/joss/stick4_","extension":".png","frames":2,"frameRate":5
            },
            {
                "name":"长寿香", "price":20, "include":[],"swidth":650,"sheight":488,"width":200,"height":160,
                "src":"./assets/images/aburnjoss/tributes/joss/stick5_","extension":".png","frames":2,"frameRate":5
            },
            {
                "name":"大香", "price":20, "include":[],"swidth":650,"sheight":488,"width":200,"height":160,
                "src":"./assets/images/aburnjoss/tributes/joss/stick6_","extension":".png","frames":2,"frameRate":5
            },
            {
                "name":"高升香", "price":20, "include":[],"swidth":650,"sheight":488,"width":200,"height":160,
                "src":"./assets/images/aburnjoss/tributes/joss/stick7_","extension":".png","frames":2,"frameRate":5
            },
            {
                "name":"红运香", "price":20, "include":[],"swidth":650,"sheight":488,"width":200,"height":160,
                "src":"./assets/images/aburnjoss/tributes/joss/stick8_","extension":".png","frames":2,"frameRate":5
            },
            {
                "name":"祈福香", "price":20, "include":[],"swidth":650,"sheight":488,"width":200,"height":160,
                "src":"./assets/images/aburnjoss/tributes/joss/stick9_","extension":".png","frames":2,"frameRate":5
            },
            {
                "name":"求子香", "price":20, "include":[],"swidth":650,"sheight":488,"width":200,"height":160,
                "src":"./assets/images/aburnjoss/tributes/joss/stick10_","extension":".png","frames":2,"frameRate":5
            }
        ]
    },
    {
        "name":"蜡烛",
        "children":[
            {
                "name":"红烛", "price":25, "include":[],"swidth":650,"sheight":488,"width":416,"height":312,
                "src":"./assets/images/aburnjoss/tributes/candle/candle12_","extension":".png","frames":5,"frameRate":5
            },
            {
                "name":"吉祥烛", "price":35, "include":[],"swidth":650,"sheight":488,"width":416,"height":312,
                "src":"./assets/images/aburnjoss/tributes/candle/candle13_","extension":".png","frames":5,"frameRate":5
            },
            {
                "name":"水晶吉祥烛", "price":45, "include":[],"swidth":650,"sheight":488,"width":416,"height":312,
                "src":"./assets/images/aburnjoss/tributes/candle/candle14_","extension":".png","frames":5,"frameRate":5
            },
            {
                "name":"水晶烛", "price":40, "include":[],"swidth":650,"sheight":488,"width":416,"height":312,
                "src":"./assets/images/aburnjoss/tributes/candle/candle15_","extension":".png","frames":5,"frameRate":5
            },
            {
                "name":"鸿福烛", "price":60, "include":[],"swidth":650,"sheight":488,"width":416,"height":312,
                "src":"./assets/images/aburnjoss/tributes/candle/candle59_","extension":".png","frames":5,"frameRate":5
            },
            {
                "name":"荷花", "price":70, "include":[],"swidth":650,"sheight":488,"width":416,"height":312,
                "src":"./assets/images/aburnjoss/tributes/candle/candle16_","extension":".png","frames":5,"frameRate":5
            },
            {
                "name":"莲花", "price":80, "include":[],"swidth":650,"sheight":488,"width":416,"height":312,
                "src":"./assets/images/aburnjoss/tributes/candle/candle17_","extension":".png","frames":5,"frameRate":5
            }
        ]
    },
    {
        "name":"灯油",
        "children":[
            {
                "name":"长明灯", "price":77, "include":[],"swidth":650,"sheight":488,"width":618,"height":463,
                "src":"./assets/images/aburnjoss/tributes/dengyou/candle37_","extension":".png","frames":5,"frameRate":5
            },
            {
                "name":"青花瓷灯", "price":80, "include":[],"swidth":650,"sheight":488,"width":618,"height":463,
                "src":"./assets/images/aburnjoss/tributes/dengyou/candle38_","extension":".png","frames":5,"frameRate":5
            },
            {
                "name":"盘龙灯", "price":88, "include":[],"swidth":650,"sheight":488,"width":618,"height":463,
                "src":"./assets/images/aburnjoss/tributes/dengyou/candle39_","extension":".png","frames":5,"frameRate":5
            }
        ]
    },
    {
        "name":"水果",
        "children":[
            {
                "name":"菠萝 榴莲", "price":50, "include":[],"swidth":650,"sheight":488,"width":270,"height":200,
                "src":"./assets/images/aburnjoss/tributes/fruit/fruit_1_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"草莓 葡萄", "price":60, "include":[],"swidth":650,"sheight":488,"width":270,"height":200,
                "src":"./assets/images/aburnjoss/tributes/fruit/fruit_2_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"桂圆 金桔", "price":70, "include":[],"swidth":650,"sheight":488,"width":270,"height":200,
                "src":"./assets/images/aburnjoss/tributes/fruit/fruit_3_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"金桔 火龙果", "price":75, "include":[],"swidth":650,"sheight":488,"width":270,"height":200,
                "src":"./assets/images/aburnjoss/tributes/fruit/fruit_4_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"葡萄 榴莲", "price":78, "include":[],"swidth":650,"sheight":488,"width":270,"height":200,
                "src":"./assets/images/aburnjoss/tributes/fruit/fruit_5_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"芒果 人参果", "price":80, "include":[],"swidth":650,"sheight":488,"width":270,"height":200,
                "src":"./assets/images/aburnjoss/tributes/fruit/fruit_6_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"香蕉 苹果", "price":85, "include":[],"swidth":650,"sheight":488,"width":270,"height":200,
                "src":"./assets/images/aburnjoss/tributes/fruit/fruit_7_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"苹果 贡梨", "price":90, "include":[],"swidth":650,"sheight":488,"width":270,"height":200,
                "src":"./assets/images/aburnjoss/tributes/fruit/fruit_8_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"橙子 荔枝", "price":95, "include":[],"swidth":650,"sheight":488,"width":270,"height":200,
                "src":"./assets/images/aburnjoss/tributes/fruit/fruit_9_","extension":".png","frames":1,"frameRate":5
            }
        ]
    },
    {
        "name":"元宝",
        "children":[
            {
                "name":"银元宝", "price":35, "include":[],"swidth":650,"sheight":488,"width":680,"height":510,
                "src":"./assets/images/aburnjoss/tributes/yuanbao/yuanbao_1_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"金元宝", "price":55, "include":[],"swidth":650,"sheight":488,"width":680,"height":510,
                "src":"./assets/images/aburnjoss/tributes/yuanbao/yuanbao_2_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"莲花元宝", "price":60, "include":[],"swidth":650,"sheight":488,"width":680,"height":510,
                "src":"./assets/images/aburnjoss/tributes/yuanbao/yuanbao_3_","extension":".png","frames":1,"frameRate":5
            }
        ]
    },
    {
        "name":"烟酒",
        "children":[
            {
                "name":"中档酒茶", "price":30, "include":[],"swidth":650,"sheight":488,"width":520,"height":390,
                "src":"./assets/images/aburnjoss/tributes/yanjiu/yanjiu_1_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"中高档烟酒", "price":35, "include":[],"swidth":650,"sheight":488,"width":520,"height":390,
                "src":"./assets/images/aburnjoss/tributes/yanjiu/yanjiu_2_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"高档烟酒", "price":40, "include":[],"swidth":650,"sheight":488,"width":520,"height":390,
                "src":"./assets/images/aburnjoss/tributes/yanjiu/yanjiu_3_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"高档酒茶", "price":55, "include":[],"swidth":650,"sheight":488,"width":520,"height":390,
                "src":"./assets/images/aburnjoss/tributes/yanjiu/yanjiu_4_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"高档烟茶", "price":60, "include":[],"swidth":650,"sheight":488,"width":520,"height":390,
                "src":"./assets/images/aburnjoss/tributes/yanjiu/yanjiu_5_","extension":".png","frames":1,"frameRate":5
            }
        ]
    },
    {
        "name":"鲜花",
        "children":[
            {
                "name":"百合海棠", "price":50, "include":[],"swidth":650,"sheight":488,"width":820,"height":616,
                "src":"./assets/images/aburnjoss/tributes/flower/flower_1_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"君子兰", "price":60, "include":[],"swidth":650,"sheight":488,"width":820,"height":616,
                "src":"./assets/images/aburnjoss/tributes/flower/flower_2_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"玫瑰康乃馨", "price":70, "include":[],"swidth":650,"sheight":488,"width":820,"height":616,
                "src":"./assets/images/aburnjoss/tributes/flower/flower_3_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"金菊牡丹花", "price":80, "include":[],"swidth":650,"sheight":488,"width":820,"height":616,
                "src":"./assets/images/aburnjoss/tributes/flower/flower_4_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"茉莉紫罗兰", "price":90, "include":[],"swidth":650,"sheight":488,"width":820,"height":616,
                "src":"./assets/images/aburnjoss/tributes/flower/flower_5_","extension":".png","frames":1,"frameRate":5
            }
        ]
    },
    {
        "name":"荤食",
        "children":[
            {
                "name":"鸡 鸭", "price":88, "include":[],"swidth":650,"sheight":488,"width":195,"height":146,
                "src":"./assets/images/aburnjoss/tributes/meat/meat_1_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"鲤鱼 桂花鱼", "price":90, "include":[],"swidth":650,"sheight":488,"width":195,"height":146,
                "src":"./assets/images/aburnjoss/tributes/meat/meat_2_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"龙虾 大闸蟹", "price":99, "include":[],"swidth":650,"sheight":488,"width":195,"height":146,
                "src":"./assets/images/aburnjoss/tributes/meat/meat_3_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"鹅 五花肉", "price":95, "include":[],"swidth":650,"sheight":488,"width":195,"height":146,
                "src":"./assets/images/aburnjoss/tributes/meat/meat_4_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"全羊 烤乳猪", "price":100, "include":[],"swidth":650,"sheight":488,"width":195,"height":146,
                "src":"./assets/images/aburnjoss/tributes/meat/meat_5_","extension":".png","frames":1,"frameRate":5
            }
        ]
    },
    {
        "name":"素食",
        "children":[
            {
                "name":"洪福齐天", "price":50, "include":[],"swidth":650,"sheight":488,"width":400,"height":300,
                "src":"./assets/images/aburnjoss/tributes/vegetable/vegetable_1_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"罗汉山药羹", "price":55, "include":[],"swidth":650,"sheight":488,"width":400,"height":300,
                "src":"./assets/images/aburnjoss/tributes/vegetable/vegetable_2_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"双仙花木耳", "price":60, "include":[],"swidth":650,"sheight":488,"width":400,"height":300,
                "src":"./assets/images/aburnjoss/tributes/vegetable/vegetable_3_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"年年有余", "price":70, "include":[],"swidth":650,"sheight":488,"width":400,"height":300,
                "src":"./assets/images/aburnjoss/tributes/vegetable/vegetable_4_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"七宝玉轮", "price":80, "include":[],"swidth":650,"sheight":488,"width":400,"height":300,
                "src":"./assets/images/aburnjoss/tributes/vegetable/vegetable_5_","extension":".png","frames":1,"frameRate":5
            }
        ]
    },
    {
        "name":"其他",
        "children":[
            {
                "name":"鞭炮 平安福", "price":60, "include":[],"swidth":650,"sheight":488,"width":640,"height":480,
                "src":"./assets/images/aburnjoss/tributes/other/other_1_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"佛珠 平安福", "price":98, "include":[],"swidth":650,"sheight":488,"width":640,"height":480,
                "src":"./assets/images/aburnjoss/tributes/other/other_2_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"观音符 尊像", "price":108, "include":[],"swidth":650,"sheight":488,"width":640,"height":480,
                "src":"./assets/images/aburnjoss/tributes/other/other_3_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"元宝 观音像", "price":98, "include":[],"swidth":650,"sheight":488,"width":640,"height":480,
                "src":"./assets/images/aburnjoss/tributes/other/other_4_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"糖果 袈裟", "price":80, "include":[],"swidth":650,"sheight":488,"width":640,"height":480,
                "src":"./assets/images/aburnjoss/tributes/other/other_5_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"糖果 金元宝", "price":68, "include":[],"swidth":650,"sheight":488,"width":640,"height":480,
                "src":"./assets/images/aburnjoss/tributes/other/other_6_","extension":".png","frames":1,"frameRate":5
            }
        ]
    },
    {
        "name":"套装",
        "children":[
            { "name":"虔诚套装1", "price":0, "include":[] },
            { "name":"虔诚套装2", "price":220, "include":["0-1","1-1","2-1","3-6"] },
            { "name":"虔诚套装3", "price":280, "include":["0-1","1-3","2-1","3-7","6-0"] },
            { "name":"虔诚套装4", "price":368, "include":["0-9","1-6","2-2","3-2","6-0","8-2"] },
            { "name":"供于诸神明", "price":496, "include":["0-2","1-4","2-2","3-3","4-1","6-1","8-3","9-5"] },

            { "name":"供于诸神明2", "price":603, "include":["0-6","1-3","2-0","3-1","4-0","5-3","6-3","7-0","8-0","9-3"] },
            { "name":"供于诸神明5", "price":608, "include":["0-1","1-1","2-1","3-6","4-2","5-1","6-2","7-0","8-1","9-4"] },
            { "name":"供于诸神明6", "price":651, "include":["0-3","1-0","2-2","3-6","4-1","5-4","6-3","7-1","8-0","9-1"] },
            { "name":"供于诸神明7", "price":676, "include":["0-2","1-4","2-1","3-4","4-2","5-2","6-0","7-4","8-4","9-2"] },
            { "name":"供于诸神明8", "price":616, "include":["0-8","1-1","2-2","3-1","4-2","5-1","6-2","7-1","8-2","9-1"] }
        ]
    }
]
var fnLoading = function(images,callback){
    var queue = images.slice(0);
    queue.forEach(function(item,index){
        item.onload = function(){
            queue.splice(index,1);
        };
        item.onerror = function(){
            throw Error("图片地址不正确,请确认数据格式正确并且没有缺少数据");
        }
    });
    var complete = function(){
        callback();
    };
    var loading = function(){
        var _interval = setInterval(function(){
            if(queue.length === 0){
                clearInterval(_interval);
                complete();
            }else{
                if(queue[0].width > 0){
                    queue.splice(0,1);
                }
            }
        },40)
    }
    loading();
}
var GifElement = function(parent,elm){
    this.parent = parent;
    this.elm = elm;
    this.ctx = elm.getContext("2d");
    this.imgs = [];
};
GifElement.prototype = {
    status:"dead",
    load : function(data){
        var _this = this;
        for(var i = 0,len = data.frames;i < len;i++){
            var _img = document.createElement("img");
            _img.src = data.src + (i+1) + data.extension;
            this.imgs.push(_img);
        }
        this.swidth = data.swidth;
        this.sheight = data.sheight;
        this.width = data.width;
        this.height = data.height;
        this.elm.width = data.width;
        this.elm.height = data.height;
        this.frames = data.frames;
        this.frameRate = 1000 / data.frameRate;

        fnLoading(this.imgs,function(){
            _this.loading = true;
            _this.parent.appendChild(_this.elm);
            setTimeout(function(){
                _this.run()
            },100);
        });
    },
    run:function(){
        if(this.loading){
            this.status = "live";
            this.elm.classList.add("active");
            this.render(0);
        }
    },
    stop:function(){
        this.status = "dead";
        this.elm.classList.remove("active");
    },
    render : function(n){
        var _this = this;
        _this.ctx.clearRect(0,0,_this.width,_this.height);
        _this.ctx.drawImage(_this.imgs[n],0,0,_this.swidth,_this.sheight,0,0,_this.width,_this.height);

        if(_this.frames > 1 && _this.status === "live"){
            setTimeout(function(){
                n++;
                if(n === _this.frames){
                    n = 0;
                }
                _this.render(n);
            },_this.frameRate);
        }
    }
};

var fnDoubleDigit = function(n){
    return ("0" + n).substr(-2,2);
};

var ABurnjoss = {
    foCarousel:function(){
        var oFoUl = $(".fo-lists");
        var oFoLists = $(".fo-lists li");
        var nLiCounts = oFoLists.length;
        var oLeftButton = $(".fo-handle .arrow-left");
        var oRightButton = $(".fo-handle .arrow-right");
        var oActiveLi = $(".fo-lists li.active");
        var nCurrentId = 0, nInitLeft, oTargetLi,isMoving = false;
        var fnSlide = function(n){
            if(!isMoving){
                isMoving = true;
                if(nCurrentId === 0 && n === 1){
                    oFoLists.last().prependTo(oFoUl);
                    oFoLists = $(".fo-lists li");
                    nCurrentId = 1;
                }else if(nCurrentId === nLiCounts - 1 && n === -1){
                    oFoLists.first().appendTo(oFoUl);
                    oFoLists = $(".fo-lists li");
                    nCurrentId = nLiCounts - 2;
                }
                nCurrentId = nCurrentId - n;

                oActiveLi.animate({"left":n*1000},100,function(){
                    $(this).removeClass("active");
                });
                oActiveLi = oFoLists.eq(nCurrentId).css({"left":-n*1000}).animate({"left":0},100,function(){
                    $(this).addClass("active");
                    isMoving = false;
                });
            }
        };
        oLeftButton.bind("click",function(){
            fnSlide(1);
        });
        oRightButton.bind("click",function(){
            fnSlide(-1);
        });
    },
    tributeSwitch:function(){
        var oTributeNav = $(".tribute-lists-nav");
        var oTributeNavs = $(".tribute-lists-nav span");
        var oTributeUl = $(".tribute-lists");
        var oTributeLists = $(".tribute-lists li");
        oTributeNavs.each(function(){
            var _this = $(this);
            var _id = _this.index();
            var oTributeLi = oTributeLists.eq(_id);
            _this.bind("mouseenter",function(){
                oTributeNav.find(".active").removeClass("active");
                _this.addClass("active");
                oTributeUl.find(".display-block").removeClass("display-block");
                oTributeLi.addClass("display-block");
            });
        });
    },
    oLayerBlock:$(".layer-block"),
    onOpenMeritBox:function(){
        var _this = this;
        var oMeritBox = $(".merit-box");
        var oLayerMeritBox = $(".layer-merit-box");
        var oCloseMeritBox = $(".close-layer-merit");
        oMeritBox.bind("click",function(){
            _this.oLayerBlock.fadeIn();
            oLayerMeritBox.fadeIn();
        });
        oCloseMeritBox.bind("click",function(){
            _this.oLayerBlock.fadeOut();
            oLayerMeritBox.fadeOut();
        });
    },
    onDrawPot:function(){
        var _this = this;
        var oDrawPot = $(".draw-pot");
        var oLayerDrawPot = $(".layer-draw-pot");
        var oDrawStart = $(".draw-start");
        var oDrawOver = $(".draw-over");
        var oDrawResult = $(".draw-result");
        var oLayerDrawClose = $(".layer-draw-close");
        oDrawPot.bind("click",function(){
            _this.oLayerBlock.fadeIn();
            oLayerDrawPot.fadeIn();
        });
        oDrawStart.bind("click",function(){
            oDrawStart.hide();
            oDrawOver.show();
            setTimeout(function(){
                oDrawOver.hide();
                oDrawResult.fadeIn();
            },700);
        });
        oLayerDrawClose.bind("click",function(){
            _this.oLayerBlock.fadeOut();
            oLayerDrawPot.fadeOut(function(){
                oDrawResult.hide();
                oDrawStart.show();
            });
        });
    },
    totalPrice:0,
    selectedTribute:{},
    sampleLists:{},
    insertElm:function(data,type,id){
        var _this = this;
        var sSampleKey = type;
        var sSampleActiveKey = sSampleKey + "-" + id;
        if(_this.sampleLists[sSampleKey]){
            _this.sampleLists[sSampleKey].stop();
        }
        if(!_this.sampleLists[sSampleActiveKey]){
            var _parent = document.getElementById("sample-"+sSampleKey);
            _this.sampleLists[sSampleActiveKey] = new GifElement(_parent,document.createElement("canvas"));
            _this.sampleLists[sSampleActiveKey].load(data);
        }else{
            _this.sampleLists[sSampleActiveKey].run();
        }
        _this.selectedTribute[sSampleKey] = data.price;
        _this.sampleLists[sSampleKey] = _this.sampleLists[sSampleActiveKey];
    },
    renderTribute:function(){
        var _this = this;
        var _ul = document.createDocumentFragment(),
            _li,_span,_sample;
        var oTributeUl = $(".tribute-lists");
        var oTributeAmount = $(".tribute-confirm-submit p");
        for(var i = 0,len = Tributes.length;i<len;i++){
            _li = document.createElement("li");
            _li.className = "type"+fnDoubleDigit(i+1) + (i === 0 ? " display-block":"");
            for(var j = 0,jLen = Tributes[i].children.length;j<jLen;j++){
                var nTributeId = fnDoubleDigit(j+1);
                var nFrames = Tributes[i].children[j].frames;

                _span = document.createElement("span");
                _span.className = "t"+nTributeId;
                _span.title = Tributes[i].children[j].name;
                _span.setAttribute("data-type","type"+fnDoubleDigit(i+1));
                _span.setAttribute("data-price",Tributes[i].children[j].price);
                (function(id,data){
                    _span.addEventListener("click",function(){
                        var sDataType = this.getAttribute("data-type");
                        var sSampleKey = sDataType + "-" + id;

                        if(data.include.length > 0){
                            _this.selectedTribute = {};
                            for(var prop in _this.sampleLists){
                                _this.sampleLists[prop].stop();
                            }
                            data.include.forEach(function(item){
                                var arrIndex = item.split("-");
                                _this.insertElm(Tributes[arrIndex[0]].children[arrIndex[1]],"type"+fnDoubleDigit(parseInt(arrIndex[0])+1),fnDoubleDigit(arrIndex[1]+1))
                            });
                        }else{
                            _this.insertElm(data,sDataType,id);
                        }

                        _this.totalPrice = 0;
                        for(var prop in _this.selectedTribute){
                            _this.totalPrice += _this.selectedTribute[prop];
                        };
                        oTributeAmount.html("共 "+ _this.totalPrice +" 两");
                    })
                }(nTributeId,Tributes[i].children[j]));
                _li.appendChild(_span);
            }
            _ul.appendChild(_li);
        }
        oTributeUl.append(_ul);
    },
    onConfirmMeritBox:function(){
        var _this = this,
            oInputMeritBox = $(".input-merit-amount"),
            oConfirmMeritAmount = $(".confirm-merit-amount"),
            oLayerMeritBox = $(".layer-merit-box"),
            oHintMeritBox = $(".layer-hint-merit"),
            _regex = /^[0-9]+$/;

        oConfirmMeritAmount.bind("click",function(){
            nMeritBoxValue = oInputMeritBox.val().trim();
            if(_regex.test(nMeritBoxValue)){
                console.log(nMeritBoxValue);
                _this.oLayerBlock.fadeOut();
                oLayerMeritBox.fadeOut();
                oHintMeritBox.css({"top":0}).show().animate({"top":300},1000,function(){
                    setTimeout(function(){
                        oHintMeritBox.fadeOut();
                    },500);
                });
            }else{
                alert("请输入正确金额");
            }
        });
    },
    onConfirmTributes:function(){
        var _this = this;
        var oConfirmTributes = $(".tribute-confirm-submit input");
        var oHintTribute = $(".layer-hint-tribute");
        var _bottom = {},_direction = "bottom",nTimes = 0;
        oConfirmTributes.bind("click",function(){
            if(_this.totalPrice === 0){
                oHintTribute.show();
                (function(){
                    if(nTimes <= 3){
                        nTimes++;
                        if(_direction === "bottom"){
                            _direction = "top";
                            _bottom = { "bottom":100 }
                        }else if(_direction === "top"){
                            _direction = "bottom"
                            _bottom = { "bottom":130 }
                        }
                        oHintTribute.animate(_bottom,700,arguments.callee)
                    }else{
                        nTimes = 0;
                        oHintTribute.stop().hide();
                        return true;
                    }
                }())
            }
        });
    },
    onPyHuanyuan : function(){
        var _this = this;
        var oPyHuanyuan = $(".py-huanyuan");
        var oLayerPyHuanyuan = $(".layer-py-huanyuan");
        var oLyaerPyHuanyuanClose = $(".layer-py-huanyuan-close");
        oPyHuanyuan.bind("click",function(){
            _this.oLayerBlock.fadeIn();
            oLayerPyHuanyuan.fadeIn();
        });
        oLyaerPyHuanyuanClose.bind("click",function(){
            _this.oLayerBlock.fadeOut();
            oLayerPyHuanyuan.fadeOut();
        })
    },
    start:function(){
        this.foCarousel();
        this.renderTribute();
        this.tributeSwitch();
        this.onPyHuanyuan();
        this.onOpenMeritBox();
        this.onDrawPot();
        this.onConfirmTributes();
        this.onConfirmMeritBox();
    }
}
var lastTime = 0;
var vendors = ['webkit', 'moz'];
for(var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
    window.requestAnimationFrame = window[vendors[x] + 'RequestAnimationFrame'];
    window.cancelAnimationFrame = window[vendors[x] + 'CancelAnimationFrame'] ||    // Webkit中此取消方法的名字变了
                                  window[vendors[x] + 'CancelRequestAnimationFrame'];
}

if (!window.requestAnimationFrame) {
    window.requestAnimationFrame = function(callback, element) {
        var currTime = new Date().getTime();
        var timeToCall = Math.max(0, 16.7 - (currTime - lastTime));
        var id = window.setTimeout(function() {
            callback(currTime + timeToCall);
        }, timeToCall);
        lastTime = currTime + timeToCall;
        return id;
    };
}
if (!window.cancelAnimationFrame) {
    window.cancelAnimationFrame = function(id) {
        clearTimeout(id);
    };
}

var AnimalManifest = {
    "hamster":{
        stay:["./assets/images/afreeanimal/mouse/mouse"],
        move:["./assets/images/afreeanimal/mouse/mouse2_"]
    },
    "goose":{
        stay:["./assets/images/afreeanimal/goose/goose"],
        move:["./assets/images/afreeanimal/goose/goose2_"]
    },
    "seaotter":{
        stay:["./assets/images/afreeanimal/seaotter/seaotter"],
        move:["./assets/images/afreeanimal/seaotter/seaotter2_"]
    },
    "rabbit":{
        stay:["./assets/images/afreeanimal/rabbit/rabbit"],
        move:["./assets/images/afreeanimal/rabbit/rabbit2_"]
    },
    "deer":{
        stay:["./assets/images/afreeanimal/sikadeer/sikadeer"],
        move:["./assets/images/afreeanimal/sikadeer/sikadeer2_"]
    },
    "koala":{
        stay:["./assets/images/afreeanimal/koala/koala"],
        move:["./assets/images/afreeanimal/koala/koala2_"]
    },
    "flamingo":{
        stay:["./assets/images/afreeanimal/flamingo/flamingo"],
        move:["./assets/images/afreeanimal/flamingo/flamingo2_"]
    }
}
var deepCopy = function(obj){
    var newObj = {}
    for(var i in obj){
        newObj[i] = obj[i];
    }
    return newObj;
}
var AFreeAnimal = {
    selectedName:"",
    selectedCount:1,
    selectedUnitPrice:20,
    animalList:{},
    onDisplayAnimal :function(){
        var _this = this;
        var oAnimalLists = $(".animal-lists li");
        var oAnimalDisplayContainer = $(".animal-show-container");
        var oAnimalName = $(".animal-name");
        var oInputAnimalCount = $(".animal-count input");
        var oAnimalTotalPrice = $(".animal-cost span");
        oAnimalLists.each(function(){
            var $this = $(this);
            $this.bind("click",function(){
                var sAnimalName = $this.attr("data-name");
                if(_this.selectedName != sAnimalName){
                    _this.selectedCount = 1;
                    _this.selectedUnitPrice = $this.attr("data-price");
                    oAnimalName.html("名称："+$this.find("label").html()).show();
                    oInputAnimalCount.val(_this.selectedCount);
                    oAnimalTotalPrice.html(_this.selectedUnitPrice);

                    if(_this.runningAnimal){
                        _this.runningAnimal.stop();
                    }else{
                        $(".is-not-selected").hide();
                        _this.onCountHandle();
                    }
                    if(_this.animalList[sAnimalName]){
                        _this.animalList[sAnimalName].stay();
                    }else{
                        var _animal = new Animal(100,70);
                        _animal.setStayFrames($this.attr("data-frames"),150);
                        _animal.setMoveFrames($this.attr("data-move-frames"),150)
                        _animal.load(AnimalManifest[sAnimalName]);
                        _animal.setImageZoom(0,0,650,488);
                        _this.animalList[sAnimalName] = _animal;
                        oAnimalDisplayContainer.append(_animal.o);
                    }
                    _this.runningAnimal = _this.animalList[sAnimalName];
                }
                _this.selectedName = sAnimalName;
            });
        });
    },
    onCountHandle:function(){
        var _this = this;
        var oPlusButton = $(".plus-button");
        var oMinusButton = $(".minus-button");
        var oInputAnimalCount = $(".animal-count input");
        var oAnimalTotalPrice = $(".animal-cost span");
        var nPriceCount;
        oPlusButton.bind("click",function(){
            _this.selectedCount++;
            nPriceCount = _this.selectedUnitPrice * _this.selectedCount;
            oInputAnimalCount.val(_this.selectedCount);
            oAnimalTotalPrice.html(nPriceCount);
        });
        oMinusButton.bind("click",function(){
            if(_this.selectedCount > 0){
                _this.selectedCount--;
                nPriceCount = _this.selectedUnitPrice * _this.selectedCount;
                oInputAnimalCount.val(_this.selectedCount);
                oAnimalTotalPrice.html(nPriceCount);
            }
        });
    },
    animalInFarm:{
        length:0
    },
    onPurchaseAnimal:function(){
        var _this = this;
        var oPurchaseAnimalButton = $(".animal-purchase-button");
        var oLayerAnimalShop = $(".layer-animal-shop");
        var oAnimalFarm = $(".animal-farm");
        var nMaxLeft = oAnimalFarm.width();
        var nMaxTop = oAnimalFarm.height();

        oPurchaseAnimalButton.bind("click",function(){
            for(var i = 0;i < _this.selectedCount;i++){
                var newAnimal = deepCopy(_this.runningAnimal);
                newAnimal.init();
                newAnimal.setImageZoom(162,122,325,244);
                var x = Math.round(Math.random() * nMaxLeft) - 65;
                var y = Math.round(Math.random() * nMaxTop) - 45;
                newAnimal.randomRender(x,y);
                _this.animalInFarm["id-"+_this.animalInFarm.length] = newAnimal;
                newAnimal.o.id = "id-"+_this.animalInFarm.length;
                oAnimalFarm.append(newAnimal.o);
                _this.animalInFarm.length++;
            }
            oLayerAnimalShop.fadeOut();
        });
    },
    onReleaseAnimal:function(){
        var _this = this;
        var oAnimalFarm = $(".animal-farm");
        var oLayerReleaseAnimal = $(".layer-release-animal");
        oAnimalFarm.bind("click",function(e){
            _this.willReleaseAnimal = e.target;
            oLayerReleaseAnimal.fadeIn();
        });
    },
    onConfirmReleaseAnimal:function(){
        var _this = this;
        var oAFreeAnimal = $(".afreeanimal-container");
        var oConfirmRelease = $(".animal-release-button");
        var oLayerReleaseAnimal = $(".layer-release-animal");
        oConfirmRelease.bind("click",function(){
            oLayerReleaseAnimal.fadeOut(function(){
                var _animal = _this.animalInFarm[_this.willReleaseAnimal.getAttribute("id")];
                _animal.stop();
                _animal.setImageZoom(0,0,1000,600);
                _animal.setStartPoint(250,150);
                _animal.setCanvasSize(1000,600);
                _animal.o.style.position = "absolute";
                _animal.o.style.top = 0;
                _animal.o.style.left = 0;
                oAFreeAnimal.append(_animal.o);
                _animal.leave();
                // _this.willReleaseAnimal.parentNode.removeChild(_this.willReleaseAnimal);
            })
        });
    },
    start:function(){
        this.onDisplayAnimal();
        this.onPurchaseAnimal();
        this.onReleaseAnimal();
        this.onConfirmReleaseAnimal();
    }
}

var Animal = function(w,h){
    this.w = w;
    this.h = h;
    this.stayImages = [];
    this.moveImages = [];
};
Animal.prototype = {
    load:function(manifest){
        var _image;
        for(var i = 0;i<this.stayFrames;i++){
            _image = document.createElement("img");
            _image.src = manifest.stay + (i + 1) + ".png";
            this.stayImages.push(_image);
        }
        for(var i = 0;i<this.moveFrames;i++){
            _image = document.createElement("img");
            _image.src = manifest.move + (i + 1) + ".png";
            this.moveImages.push(_image);
        }

        this.init();
    },
    setImageZoom:function(sl,st,sw,sh){
        this.sl = sl;
        this.st = st;
        this.sw = sw;
        this.sh = sh;
    },
    setCanvasSize:function(w,h){
        this.w = w;
        this.h = h;
        this.o.width = w;
        this.o.height = h;
    },
    setStartPoint:function(x,y){
        this.cx = x;
        this.cy = y;
    },
    setStayFrames:function(value,rate){
        this.stayFrames = value;
        this.stayRate = rate;
    },
    setMoveFrames:function(value,rate){
        this.moveFrames = value;
        this.moveRate = rate;
    },
    init:function(){
        this.o = document.createElement("canvas");
        this.o.width = 100;
        this.o.height = 70;
        this.ctx = this.o.getContext("2d");
        this.cx = 0;
        this.cy = 0;
        this.stay();
    },
    randomRender:function(x,y){
        this.o.style.left = x + "px";
        this.o.style.top = y + "px";
    },
    render:function(images,frames,rate){
        var _this = this;
        _this.ctx.clearRect(0,0,_this.w,_this.h);
        if(frames == _this.stayFrames){
            if(_this.status === "leaving"){
                _this.status = "paused";
                _this.remove();
            }else{
                frames = 0;
            }
        };
        _this.ctx.drawImage(images[frames],_this.sl,_this.st,_this.sw,_this.sh,_this.cx,_this.cy,_this.w,_this.h);
        frames++;

        if(_this.status !== "paused"){
            _this.timeout = setTimeout(function(){
                _this.render(images,frames,rate);
            },rate);
        }
    },
    stay:function(){
        this.o.style.display = "block";
        this.status = "staying";
        this.render(this.stayImages,0,this.stayRate);
    },
    stop:function(){
        this.o.style.display = "none";
        this.status = "paused";
        clearTimeout(this.timeout);
    },
    leave:function(){
        console.log("leave");
        this.o.style.display = "block";
        this.status = "leaving";
        this.render(this.moveImages,0,this.moveRate);
    },
    remove:function(){
        this.o.parentNode.removeChild(this.o);
    }
}