var Tributes = [
    {
        "name":"香",
        "children":[
            {
                "name":"功德香", "price":20, "include":[],"swidth":400,"sheight":300,"width":200,"height":160,
                "src":"./assets/images/aburnjoss/tributes/joss/stick1_","extension":".png","frames":2,"frameRate":5
            },
            {
                "name":"平安香", "price":20, "include":[],"swidth":650,"sheight":488,"width":200,"height":160,
                "src":"./assets/images/aburnjoss/tributes/joss/stick2_","extension":".png","frames":2,"frameRate":5
            },
            {
                "name":"求财香", "price":20, "include":[],"swidth":650,"sheight":488,"width":200,"height":160,
                "src":"./assets/images/aburnjoss/tributes/joss/stick3_","extension":".png","frames":2,"frameRate":5
            },
            {
                "name":"檀香", "price":20, "include":[],"swidth":650,"sheight":488,"width":200,"height":160,
                "src":"./assets/images/aburnjoss/tributes/joss/stick4_","extension":".png","frames":2,"frameRate":5
            },
            {
                "name":"长寿香", "price":20, "include":[],"swidth":650,"sheight":488,"width":200,"height":160,
                "src":"./assets/images/aburnjoss/tributes/joss/stick5_","extension":".png","frames":2,"frameRate":5
            },
            {
                "name":"大香", "price":20, "include":[],"swidth":650,"sheight":488,"width":200,"height":160,
                "src":"./assets/images/aburnjoss/tributes/joss/stick6_","extension":".png","frames":2,"frameRate":5
            },
            {
                "name":"高升香", "price":20, "include":[],"swidth":650,"sheight":488,"width":200,"height":160,
                "src":"./assets/images/aburnjoss/tributes/joss/stick7_","extension":".png","frames":2,"frameRate":5
            },
            {
                "name":"红运香", "price":20, "include":[],"swidth":650,"sheight":488,"width":200,"height":160,
                "src":"./assets/images/aburnjoss/tributes/joss/stick8_","extension":".png","frames":2,"frameRate":5
            },
            {
                "name":"祈福香", "price":20, "include":[],"swidth":650,"sheight":488,"width":200,"height":160,
                "src":"./assets/images/aburnjoss/tributes/joss/stick9_","extension":".png","frames":2,"frameRate":5
            },
            {
                "name":"求子香", "price":20, "include":[],"swidth":650,"sheight":488,"width":200,"height":160,
                "src":"./assets/images/aburnjoss/tributes/joss/stick10_","extension":".png","frames":2,"frameRate":5
            }
        ]
    },
    {
        "name":"蜡烛",
        "children":[
            {
                "name":"红烛", "price":25, "include":[],"swidth":650,"sheight":488,"width":416,"height":312,
                "src":"./assets/images/aburnjoss/tributes/candle/candle12_","extension":".png","frames":5,"frameRate":5
            },
            {
                "name":"吉祥烛", "price":35, "include":[],"swidth":650,"sheight":488,"width":416,"height":312,
                "src":"./assets/images/aburnjoss/tributes/candle/candle13_","extension":".png","frames":5,"frameRate":5
            },
            {
                "name":"水晶吉祥烛", "price":45, "include":[],"swidth":650,"sheight":488,"width":416,"height":312,
                "src":"./assets/images/aburnjoss/tributes/candle/candle14_","extension":".png","frames":5,"frameRate":5
            },
            {
                "name":"水晶烛", "price":40, "include":[],"swidth":650,"sheight":488,"width":416,"height":312,
                "src":"./assets/images/aburnjoss/tributes/candle/candle15_","extension":".png","frames":5,"frameRate":5
            },
            {
                "name":"鸿福烛", "price":60, "include":[],"swidth":650,"sheight":488,"width":416,"height":312,
                "src":"./assets/images/aburnjoss/tributes/candle/candle59_","extension":".png","frames":5,"frameRate":5
            },
            {
                "name":"荷花", "price":70, "include":[],"swidth":650,"sheight":488,"width":416,"height":312,
                "src":"./assets/images/aburnjoss/tributes/candle/candle16_","extension":".png","frames":5,"frameRate":5
            },
            {
                "name":"莲花", "price":80, "include":[],"swidth":650,"sheight":488,"width":416,"height":312,
                "src":"./assets/images/aburnjoss/tributes/candle/candle17_","extension":".png","frames":5,"frameRate":5
            }
        ]
    },
    {
        "name":"灯油",
        "children":[
            {
                "name":"长明灯", "price":77, "include":[],"swidth":650,"sheight":488,"width":618,"height":463,
                "src":"./assets/images/aburnjoss/tributes/dengyou/candle37_","extension":".png","frames":5,"frameRate":5
            },
            {
                "name":"青花瓷灯", "price":80, "include":[],"swidth":650,"sheight":488,"width":618,"height":463,
                "src":"./assets/images/aburnjoss/tributes/dengyou/candle38_","extension":".png","frames":5,"frameRate":5
            },
            {
                "name":"盘龙灯", "price":88, "include":[],"swidth":650,"sheight":488,"width":618,"height":463,
                "src":"./assets/images/aburnjoss/tributes/dengyou/candle39_","extension":".png","frames":5,"frameRate":5
            }
        ]
    },
    {
        "name":"水果",
        "children":[
            {
                "name":"菠萝 榴莲", "price":50, "include":[],"swidth":650,"sheight":488,"width":270,"height":200,
                "src":"./assets/images/aburnjoss/tributes/fruit/fruit_1_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"草莓 葡萄", "price":60, "include":[],"swidth":650,"sheight":488,"width":270,"height":200,
                "src":"./assets/images/aburnjoss/tributes/fruit/fruit_2_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"桂圆 金桔", "price":70, "include":[],"swidth":650,"sheight":488,"width":270,"height":200,
                "src":"./assets/images/aburnjoss/tributes/fruit/fruit_3_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"金桔 火龙果", "price":75, "include":[],"swidth":650,"sheight":488,"width":270,"height":200,
                "src":"./assets/images/aburnjoss/tributes/fruit/fruit_4_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"葡萄 榴莲", "price":78, "include":[],"swidth":650,"sheight":488,"width":270,"height":200,
                "src":"./assets/images/aburnjoss/tributes/fruit/fruit_5_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"芒果 人参果", "price":80, "include":[],"swidth":650,"sheight":488,"width":270,"height":200,
                "src":"./assets/images/aburnjoss/tributes/fruit/fruit_6_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"香蕉 苹果", "price":85, "include":[],"swidth":650,"sheight":488,"width":270,"height":200,
                "src":"./assets/images/aburnjoss/tributes/fruit/fruit_7_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"苹果 贡梨", "price":90, "include":[],"swidth":650,"sheight":488,"width":270,"height":200,
                "src":"./assets/images/aburnjoss/tributes/fruit/fruit_8_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"橙子 荔枝", "price":95, "include":[],"swidth":650,"sheight":488,"width":270,"height":200,
                "src":"./assets/images/aburnjoss/tributes/fruit/fruit_9_","extension":".png","frames":1,"frameRate":5
            }
        ]
    },
    {
        "name":"元宝",
        "children":[
            {
                "name":"银元宝", "price":35, "include":[],"swidth":650,"sheight":488,"width":680,"height":510,
                "src":"./assets/images/aburnjoss/tributes/yuanbao/yuanbao_1_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"金元宝", "price":55, "include":[],"swidth":650,"sheight":488,"width":680,"height":510,
                "src":"./assets/images/aburnjoss/tributes/yuanbao/yuanbao_2_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"莲花元宝", "price":60, "include":[],"swidth":650,"sheight":488,"width":680,"height":510,
                "src":"./assets/images/aburnjoss/tributes/yuanbao/yuanbao_3_","extension":".png","frames":1,"frameRate":5
            }
        ]
    },
    {
        "name":"烟酒",
        "children":[
            {
                "name":"中档酒茶", "price":30, "include":[],"swidth":650,"sheight":488,"width":520,"height":390,
                "src":"./assets/images/aburnjoss/tributes/yanjiu/yanjiu_1_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"中高档烟酒", "price":35, "include":[],"swidth":650,"sheight":488,"width":520,"height":390,
                "src":"./assets/images/aburnjoss/tributes/yanjiu/yanjiu_2_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"高档烟酒", "price":40, "include":[],"swidth":650,"sheight":488,"width":520,"height":390,
                "src":"./assets/images/aburnjoss/tributes/yanjiu/yanjiu_3_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"高档酒茶", "price":55, "include":[],"swidth":650,"sheight":488,"width":520,"height":390,
                "src":"./assets/images/aburnjoss/tributes/yanjiu/yanjiu_4_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"高档烟茶", "price":60, "include":[],"swidth":650,"sheight":488,"width":520,"height":390,
                "src":"./assets/images/aburnjoss/tributes/yanjiu/yanjiu_5_","extension":".png","frames":1,"frameRate":5
            }
        ]
    },
    {
        "name":"鲜花",
        "children":[
            {
                "name":"百合海棠", "price":50, "include":[],"swidth":650,"sheight":488,"width":820,"height":616,
                "src":"./assets/images/aburnjoss/tributes/flower/flower_1_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"君子兰", "price":60, "include":[],"swidth":650,"sheight":488,"width":820,"height":616,
                "src":"./assets/images/aburnjoss/tributes/flower/flower_2_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"玫瑰康乃馨", "price":70, "include":[],"swidth":650,"sheight":488,"width":820,"height":616,
                "src":"./assets/images/aburnjoss/tributes/flower/flower_3_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"金菊牡丹花", "price":80, "include":[],"swidth":650,"sheight":488,"width":820,"height":616,
                "src":"./assets/images/aburnjoss/tributes/flower/flower_4_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"茉莉紫罗兰", "price":90, "include":[],"swidth":650,"sheight":488,"width":820,"height":616,
                "src":"./assets/images/aburnjoss/tributes/flower/flower_5_","extension":".png","frames":1,"frameRate":5
            }
        ]
    },
    {
        "name":"荤食",
        "children":[
            {
                "name":"鸡 鸭", "price":88, "include":[],"swidth":650,"sheight":488,"width":195,"height":146,
                "src":"./assets/images/aburnjoss/tributes/meat/meat_1_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"鲤鱼 桂花鱼", "price":90, "include":[],"swidth":650,"sheight":488,"width":195,"height":146,
                "src":"./assets/images/aburnjoss/tributes/meat/meat_2_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"龙虾 大闸蟹", "price":99, "include":[],"swidth":650,"sheight":488,"width":195,"height":146,
                "src":"./assets/images/aburnjoss/tributes/meat/meat_3_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"鹅 五花肉", "price":95, "include":[],"swidth":650,"sheight":488,"width":195,"height":146,
                "src":"./assets/images/aburnjoss/tributes/meat/meat_4_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"全羊 烤乳猪", "price":100, "include":[],"swidth":650,"sheight":488,"width":195,"height":146,
                "src":"./assets/images/aburnjoss/tributes/meat/meat_5_","extension":".png","frames":1,"frameRate":5
            }
        ]
    },
    {
        "name":"素食",
        "children":[
            {
                "name":"洪福齐天", "price":50, "include":[],"swidth":650,"sheight":488,"width":400,"height":300,
                "src":"./assets/images/aburnjoss/tributes/vegetable/vegetable_1_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"罗汉山药羹", "price":55, "include":[],"swidth":650,"sheight":488,"width":400,"height":300,
                "src":"./assets/images/aburnjoss/tributes/vegetable/vegetable_2_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"双仙花木耳", "price":60, "include":[],"swidth":650,"sheight":488,"width":400,"height":300,
                "src":"./assets/images/aburnjoss/tributes/vegetable/vegetable_3_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"年年有余", "price":70, "include":[],"swidth":650,"sheight":488,"width":400,"height":300,
                "src":"./assets/images/aburnjoss/tributes/vegetable/vegetable_4_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"七宝玉轮", "price":80, "include":[],"swidth":650,"sheight":488,"width":400,"height":300,
                "src":"./assets/images/aburnjoss/tributes/vegetable/vegetable_5_","extension":".png","frames":1,"frameRate":5
            }
        ]
    },
    {
        "name":"其他",
        "children":[
            {
                "name":"鞭炮 平安福", "price":60, "include":[],"swidth":650,"sheight":488,"width":640,"height":480,
                "src":"./assets/images/aburnjoss/tributes/other/other_1_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"佛珠 平安福", "price":98, "include":[],"swidth":650,"sheight":488,"width":640,"height":480,
                "src":"./assets/images/aburnjoss/tributes/other/other_2_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"观音符 尊像", "price":108, "include":[],"swidth":650,"sheight":488,"width":640,"height":480,
                "src":"./assets/images/aburnjoss/tributes/other/other_3_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"元宝 观音像", "price":98, "include":[],"swidth":650,"sheight":488,"width":640,"height":480,
                "src":"./assets/images/aburnjoss/tributes/other/other_4_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"糖果 袈裟", "price":80, "include":[],"swidth":650,"sheight":488,"width":640,"height":480,
                "src":"./assets/images/aburnjoss/tributes/other/other_5_","extension":".png","frames":1,"frameRate":5
            },
            {
                "name":"糖果 金元宝", "price":68, "include":[],"swidth":650,"sheight":488,"width":640,"height":480,
                "src":"./assets/images/aburnjoss/tributes/other/other_6_","extension":".png","frames":1,"frameRate":5
            }
        ]
    },
    {
        "name":"套装",
        "children":[
            { "name":"虔诚套装1", "price":0, "include":[] },
            { "name":"虔诚套装2", "price":220, "include":["0-1","1-1","2-1","3-6"] },
            { "name":"虔诚套装3", "price":280, "include":["0-1","1-3","2-1","3-7","6-0"] },
            { "name":"虔诚套装4", "price":368, "include":["0-9","1-6","2-2","3-2","6-0","8-2"] },
            { "name":"供于诸神明", "price":496, "include":["0-2","1-4","2-2","3-3","4-1","6-1","8-3","9-5"] },

            { "name":"供于诸神明2", "price":603, "include":["0-6","1-3","2-0","3-1","4-0","5-3","6-3","7-0","8-0","9-3"] },
            { "name":"供于诸神明5", "price":608, "include":["0-1","1-1","2-1","3-6","4-2","5-1","6-2","7-0","8-1","9-4"] },
            { "name":"供于诸神明6", "price":651, "include":["0-3","1-0","2-2","3-6","4-1","5-4","6-3","7-1","8-0","9-1"] },
            { "name":"供于诸神明7", "price":676, "include":["0-2","1-4","2-1","3-4","4-2","5-2","6-0","7-4","8-4","9-2"] },
            { "name":"供于诸神明8", "price":616, "include":["0-8","1-1","2-2","3-1","4-2","5-1","6-2","7-1","8-2","9-1"] }
        ]
    }
]

Array.prototype.indexOf = Array.prototype.indexOf || function(str){
    var _index = -1;
    for(var i = 0,len = this.length;i < len;i++){
        if(this[i] === str){
            _index = i;
            break;
        }
    }
    return _index;
};
var ABurnjoss = {
    sCurrentFo:"fo1_guanshiyin",
    foCarousel:function(){
        var _this = this;
        var oFoUl = $(".fo-lists");
        var oFoLists = $(".fo-lists li");
        var nLiCounts = oFoLists.length;
        var oLeftButton = $(".fo-handle .arrow-left");
        var oRightButton = $(".fo-handle .arrow-right");
        var oActiveLi = $(".fo-lists li.active");
        var nCurrentId = 0, nInitLeft, oTargetLi,isMoving = false;
        var fnSlide = function(n){
            if(!isMoving){
                isMoving = true;
                if(nCurrentId === 0 && n === 1){
                    oFoLists.last().prependTo(oFoUl);
                    oFoLists = $(".fo-lists li");
                    nCurrentId = 1;
                }else if(nCurrentId === nLiCounts - 1 && n === -1){
                    oFoLists.first().appendTo(oFoUl);
                    oFoLists = $(".fo-lists li");
                    nCurrentId = nLiCounts - 2;
                }
                nCurrentId = nCurrentId - n;
                _this.nCurrentFoId = oFoLists.eq(nCurrentId).attr("data-id");
                _this.sCurrentFoName = oFoLists.eq(nCurrentId).attr("data-name");
                _this.sCurrentFo = oFoLists.eq(nCurrentId).attr("data-fo");
                _this.stopAll();
                _this.setCurrentState();

                oActiveLi.animate({"left":n*1000},100,function(){
                    $(this).removeClass("active");
                });
                oActiveLi = oFoLists.eq(nCurrentId).css({"left":-n*1000}).animate({"left":0},100,function(){
                    $(this).addClass("active");
                    isMoving = false;
                });
            }
        };
        oLeftButton.bind("click",function(){
            oActiveLi = $(".fo-lists li.active");
            nCurrentId = $(".fo-lists li.active").index();
            fnSlide(1);
        });
        oRightButton.bind("click",function(){
            oActiveLi = $(".fo-lists li.active");
            nCurrentId = $(".fo-lists li.active").index();
            fnSlide(-1);
        });
    },
    slideToFo:function(){
        var oActiveLi = $(".fo-lists li.active"),
            nCurrentId = this.nSelectedWishFoId - 1,
            oTargetLi = $(".fo-lists .fo"+this.nSelectedWishFoId),
            n;
        if(nCurrentId > oActiveLi.index()){
            n = -1;
        }else{
            n = 1;
        }
        oActiveLi.animate({"left":n*1000},100,function(){
            $(this).removeClass("active");
        });
        oTargetLi.css({"left":-n*1000}).animate({"left":0},100,function(){
            $(this).addClass("active");
            isMoving = false;
        });
        this.nCurrentFoId = oTargetLi.attr("data-id");
        this.sCurrentFoName = oTargetLi.attr("data-name");
        this.sCurrentFo = oTargetLi.attr("data-fo");
        this.stopAll();
        this.setCurrentState();
    },
    stopAll:function(){
        for(var prop in this.activeSampleLists){
            this.activeSampleLists[prop].element.stop();
        }
    },
    clearSamples:function(){
        this.foSampleList[this.sCurrentFo] = {};
        this.activeSampleLists = {};
    },
    calculateTributeAmount:function(){
        this.totalPrice = 0;
        for(var prop in this.activeSampleLists){
            this.totalPrice += this.activeSampleLists[prop].price;
        };
        this.oTributeAmount.html("共 "+ this.totalPrice +" 两");
    },
    tributeSwitch:function(){
        var oTributeNav = $(".tribute-lists-nav");
        var oTributeNavs = $(".tribute-lists-nav span");
        var oTributeUl = $(".tribute-lists");
        var oTributeLists = $(".tribute-lists li");
        oTributeNavs.each(function(){
            var _this = $(this);
            var _id = _this.index();
            var oTributeLi = oTributeLists.eq(_id);
            _this.bind("mouseenter",function(){
                oTributeNav.find(".active").removeClass("active");
                _this.addClass("active");
                oTributeUl.find(".display-block").removeClass("display-block");
                oTributeLi.addClass("display-block");
            });
        });
    },
    payBill:function(amount){
        var oLayerBalanceNotEnough = $(".layer-balance-not-enough");
        if(amount > balance){
            oLayerBalanceNotEnough.css({"margin-top":-121}).fadeIn().animate({"margin-top":-21},1500).fadeOut();
        }
    },
    noEnough:function(){
        var oLayerBalanceNotEnough = $(".layer-balance-not-enough");
        oLayerBalanceNotEnough.css({"margin-top":-121}).fadeIn().animate({"margin-top":-21},1500).fadeOut();
    },
    oLayerBlock:$(".layer-block"),
    onOpenMeritBox:function(){
        var _this = this;
        var oMeritBox = $(".merit-box");
        var oLayerMeritBox = $(".layer-merit-box");
        var oCloseMeritBox = $(".close-layer-merit");
        oMeritBox.bind("click",function(){
            _this.oLayerBlock.fadeIn();
            oLayerMeritBox.fadeIn();
        });
        oCloseMeritBox.bind("click",function(){
            _this.oLayerBlock.fadeOut();
            oLayerMeritBox.fadeOut();
        });
    },
    onDrawPot:function(){
        var _this = this;
        var oDrawPot = $(".draw-pot");
        var oLayerDrawPot = $(".layer-draw-pot");
        var oDrawStart = $(".draw-start");
        var oDrawOver = $(".draw-over");
        var oDrawResult = $(".draw-result");
        var oLayerDrawClose = $(".layer-draw-close");
        var oDrawNumber = $(".draw-number");
        var oDrawContent = $(".draw-content");
        var oDrawTitle = $(".draw-title");
        var oPyJieqian = $(".draw-py-jieqian");
        var sPyJieqianLink = "";
        oDrawPot.bind("click",function(){
            _this.oLayerBlock.fadeIn();
            oLayerDrawPot.fadeIn();
        });
        oDrawStart.bind("click",function(){
            oDrawStart.hide();
            oDrawOver.show();
            setTimeout(function(){
                dataController.drawLots(function(res){
                    console.log(res);
                    oDrawNumber.html(res.no)
                    oDrawTitle.html(res.title);
                    sPyJieqianLink = res.openUrl;
                    var arrDrawContent = res.jxexp.split("；");
                    console.log(arrDrawContent);
                    var sDrawContent = "";
                    for(var i = 0,len = arrDrawContent.length;i < len;i++){
                        sDrawContent += "<p>"+arrDrawContent[i].replace("，","<br />，")+"</p>";
                    }
                    oDrawContent.html(sDrawContent);
                    oDrawOver.hide();
                    oDrawResult.fadeIn();
                });
            },700);
        });

        oLayerDrawClose.bind("click",function(){
            _this.oLayerBlock.fadeOut();
            oLayerDrawPot.fadeOut(function(){
                oDrawResult.hide();
                oDrawStart.show();
            });
        });

        oPyJieqian.bind("click",function(){
            window.location.href = sPyJieqianLink;
        });
    },
    totalPrice:0,
    selectedTribute:{},
    sampleLists:{},
    activeSampleLists:{},
    foSampleList:{},
    insertElm:function(data,type,typeId,id){
        var _this = this;
        var sSampleKey = type;
        var sSampleActiveKey = sSampleKey + "-" + typeId;

        if(_this.activeSampleLists[sSampleKey]){
            _this.activeSampleLists[sSampleKey].element.stop();
        }
        if(!_this.sampleLists[sSampleActiveKey]){
            var _parent = document.getElementById("sample-"+sSampleKey);
            _this.sampleLists[sSampleActiveKey] = new GifElement(id,_parent,document.createElement("canvas"));
            _this.sampleLists[sSampleActiveKey].load(data);
        }

        _this.foSampleList[_this.sCurrentFo][sSampleKey] = {};
        _this.foSampleList[_this.sCurrentFo][sSampleKey].element = _this.sampleLists[sSampleActiveKey];
        _this.foSampleList[_this.sCurrentFo][sSampleKey].price = data.price;
        _this.activeSampleLists[sSampleKey] = _this.foSampleList[_this.sCurrentFo][sSampleKey];
    },
    runElm:function(){
        for(var prop in this.activeSampleLists){
            this.activeSampleLists[prop].element.run();
        }
    },
    renderTribute:function(){
        var _this = this;
        var _ul = document.createDocumentFragment(),
            _li,_span,_sample;
        var oTributeUl = $(".tribute-lists");
        for(var i = 0,len = Tributes.length;i<len;i++){
            _li = document.createElement("li");
            _li.className = "type"+fnDoubleDigit(i+1) + (i === 0 ? " display-block":"");
            for(var j = 0,jLen = Tributes[i].children.length;j<jLen;j++){
                var nTributeId = fnDoubleDigit(j+1);
                var nFrames = Tributes[i].children[j].frames;

                _span = document.createElement("span");
                _span.className = "t"+nTributeId;
                _span.title = Tributes[i].children[j].name;
                _span.setAttribute("data-type","type"+fnDoubleDigit(i+1));
                _span.setAttribute("data-price",Tributes[i].children[j].price);
                (function(typeId,id,data){
                    _span.addEventListener("click",function(){
                        var sDataType = this.getAttribute("data-type");
                        var sSampleKey = sDataType + "-" + id;

                        if(data.include.length > 0){
                            _this.stopAll();
                            _this.clearSamples();
                            data.include.forEach(function(item){
                                var arrIndex = item.split("-"),
                                    sTypeId = fnDoubleDigit(parseInt(arrIndex[0])+1),
                                    sId = fnDoubleDigit(parseInt(arrIndex[1])+1)
                                _this.insertElm(Tributes[arrIndex[0]].children[arrIndex[1]],"type"+sTypeId,sId,sTypeId+"|"+sId);
                            });
                        }else{
                            _this.insertElm(data,sDataType,id,typeId+"|"+id);
                        }
                        _this.runElm();
                        _this.calculateTributeAmount();
                    })
                }(fnDoubleDigit(i+1),nTributeId,Tributes[i].children[j]));
                _li.appendChild(_span);
            }
            _ul.appendChild(_li);
        }
        oTributeUl.append(_ul);
    },
    onConfirmMeritBox:function(){
        var _this = this,
            oInputMeritBox = $(".input-merit-amount"),
            oConfirmMeritAmount = $(".confirm-merit-amount"),
            oLayerMeritBox = $(".layer-merit-box"),
            oHintMeritBox = $(".layer-hint-merit"),
            _regex = /^[0-9]+$/;

        oConfirmMeritAmount.bind("click",function(){
            nMeritBoxValue = oInputMeritBox.val().trim();
            if(_regex.test(nMeritBoxValue)){
                _this.oLayerBlock.fadeOut();
                oLayerMeritBox.fadeOut(function(){
                    dataController.meritBox(nMeritBoxValue,function(res){
                        if(res.error == "201"){
                            _this.noEnough();
                        }else if(res.code == "100"){
                            oHintMeritBox.css({"top":0}).show().animate({"top":300},1000,function(){
                                setTimeout(function(){
                                    oHintMeritBox.fadeOut();
                                },500);
                            });
                        }
                    });
                });
            }else{
                alert("请输入正确金额");
            }
        });
    },
    onConfirmTributes:function(){
        var _this = this;
        var oConfirmTributes = $(".tribute-confirm-submit .tribute-confirm-type-1");
        var oConfirmTributesPyHuanyuan = $(".tribute-confirm-submit .tribute-confirm-type-2");
        var oHintTribute = $(".layer-hint-tribute");
        var oHintTributePyHuanyuan = $(".layer-hint-tribute-py-huanyuan");
        var oLayerMakeWish = $(".layer-make-wish");
        var oLayerWishComplete = $(".layer-wish-complete");
        var oLayerPyHuanyuanSuccess = $(".layer-py-huanyuan-complete");
        var oWishConfirm = $(".wish-confirm");
        var oWishCancel = $(".wish-cancel");
        var oWishContent = $(".wish-content");
        var oWishOptions = $(".wish-options");
        var oMakeWishOrNot = $(".make-wish-or-not");
        var oWishPrivateOrNot = $(".wish-private-or-not");
        var _bottom = {},_direction = "bottom",nTimes = 0;
        oConfirmTributes.bind("click",function(){
            if(_this.totalPrice === 0){
                oHintTribute.show();
                (function(){
                    if(nTimes <= 3){
                        nTimes++;
                        if(_direction === "bottom"){
                            _direction = "top";
                            _bottom = { "bottom":100 }
                        }else if(_direction === "top"){
                            _direction = "bottom"
                            _bottom = { "bottom":130 }
                        }
                        oHintTribute.animate(_bottom,700,arguments.callee)
                    }else{
                        nTimes = 0;
                        oHintTribute.stop().hide();
                        return true;
                    }
                }())
            }else{
                oLayerMakeWish.fadeIn();
            }
        });
        oConfirmTributesPyHuanyuan.bind("click",function(){
            if(_this.totalPrice === 0){
                oHintTributePyHuanyuan.show();
                (function(){
                    if(nTimes <= 3){
                        nTimes++;
                        if(_direction === "bottom"){
                            _direction = "top";
                            _bottom = { "bottom":105 }
                        }else if(_direction === "top"){
                            _direction = "bottom"
                            _bottom = { "bottom":130 }
                        }
                        oHintTributePyHuanyuan.animate(_bottom,700,arguments.callee)
                    }else{
                        nTimes = 0;
                        oHintTributePyHuanyuan.stop().hide();
                        return true;
                    }
                }())
            }else{
                var tributesIds = [];
                for(var i in _this.activeSampleLists){
                    tributesIds.push(_this.activeSampleLists[i].element.id);
                }

                var postData = {
                    "wish_id":_this.nSelectedWishId,                         // wish_id=0 为许愿; wish_id>0为还愿 wish与is_private可以不传
                    "foid":_this.nCurrentFoId,                            // 佛祖id
                    "foname":_this.sCurrentFoName,
                    "gp_ids":tributesIds.join(","),                   // 桌上贡品用,相隔  类型和具体贡品用|相隔
                    "bj_gold":_this.totalPrice,                       // 烧香银两
                    "stay_time":(new Date().getTime() + 30000) /1000              // 此次烧香持续到什么时间点,比如5分钟后结束即为当前时间戳+5*60
                }

                dataController.burnjoss(postData,function(res){
                    if(res.error == "201"){
                        _this.noEnough();
                    }else{
                        oLayerPyHuanyuanSuccess.fadeIn().animate({"marginTop":-41},function(){ $(this).fadeOut() });
                        _this.foCompleteList.push(_this.sCurrentFo);
                        _this.setCurrentState();
                    }
                });
            }
        });
        oWishConfirm.bind("click",function(){
            var tributesIds = [];
            for(var i in _this.activeSampleLists){
                tributesIds.push(_this.activeSampleLists[i].element.id);
            }

            var postData = {
                "wish_id":0,                         // wish_id=0 为许愿; wish_id>0为还愿 wish与is_private可以不传
                "wish":oMakeWishOrNot.find("input:checked").val() == "0"?oWishContent.html():"",                      // 许愿内容
                "is_private":oWishPrivateOrNot.find("input:checked").val(),                      // 许愿是否保密
                "foid":_this.nCurrentFoId,                            // 佛祖id
                "foname":_this.sCurrentFoName,
                "gp_ids":tributesIds.join(","),                   // 桌上贡品用,相隔  类型和具体贡品用|相隔
                "bj_gold":_this.totalPrice,                       // 烧香银两
                "stay_time":(new Date().getTime() + 30000) /1000              // 此次烧香持续到什么时间点,比如5分钟后结束即为当前时间戳+5*60
            }

            oLayerMakeWish.fadeOut(function(){
                dataController.burnjoss(postData,function(res){
                    if(res.error == "201"){
                        _this.noEnough();
                    }else{
                        oLayerWishComplete.fadeIn().animate({"marginTop":-41}).fadeOut();
                        _this.foCompleteList.push(_this.sCurrentFo);
                        // if(_this.wishData.length === 0){
                        //     $(".layer-py-huanyuan ul").html("");
                        // }
                        // $(".layer-py-huanyuan ul").prepend(_this.createWishItem({"foId":_this.nCurrentFoId,"foName":_this.sCurrentFoName,"foContent":oWishContent.html()}));
                        _this.setCurrentState();
                    }
                });
            });
        });
        oWishCancel.bind("click",function(){
            oLayerMakeWish.fadeOut()
        });
        oWishOptions.bind("change",function(){
            oWishContent.html(oWishOptions.find("option").eq($(this).prop("selectedIndex")).attr("data-desc"));
        });
    },
    onPyHuanyuan : function(){
        var _this = this;
        var oPyHuanyuan = $(".py-huanyuan");
        var oLayerPyHuanyuan = $(".layer-py-huanyuan");
        var oLyaerPyHuanyuanClose = $(".layer-py-huanyuan-close");
        oPyHuanyuan.bind("click",function(){
            _this.oLayerBlock.fadeIn();
            oLayerPyHuanyuan.fadeIn();
        });
        oLyaerPyHuanyuanClose.bind("click",function(){
            _this.oLayerBlock.fadeOut();
            oLayerPyHuanyuan.fadeOut();
        })
    },
    setCurrentState:function(){
        var _timeout,_this = this;
        clearTimeout(_timeout);
        _this.stopGlow();
        if(this.foCompleteList.indexOf(this.sCurrentFo) > -1){
            $(".aburnjoss-container").addClass("has-made-wished");
            _this.startGlow();
        }else{
            $(".aburnjoss-container").removeClass("has-made-wished");
        }
        if($(".tribute-confirm-submit").hasClass("tribute-py-huanyuan")){
            $(".tribute-confirm-submit").addClass("tribute-py-shangxiang").removeClass("tribute-py-huanyuan");
        }
        _this.oTributeAmount.html("共 0 两");
        _timeout = setTimeout(function(){
            var _currentFoSamples;
            if(_this.foSampleList[_this.sCurrentFo]){
                _currentFoSamples = _this.foSampleList[_this.sCurrentFo];
                for(var i in _currentFoSamples){
                    _currentFoSamples[i].element.run();
                }
            }else{
                _this.foSampleList[_this.sCurrentFo] = {};
                _currentFoSamples = {};
            }

            _this.activeSampleLists = _currentFoSamples;
            _this.runElm();
            _this.calculateTributeAmount();
        },500);
    },
    wishData:[],
    createWishItem:function(data){
        var _this = this;
        var oLayerPyHuanyuan = $(".layer-py-huanyuan");
        var oLayerPyHuanyuanOrNot = $(".layer-py-huanyuan-or-not");
        var newItem = $("<li id='wish-"+data.foId+"'><p class='fo-name'>"+data.foName+"</p><p class='fo-content'>"+data.foContent+"</p></li>");
        newItem.bind("click",function(){
            _this.nSelectedWishId = data.id;
            _this.nSelectedWishFoId = data.foId;
            oLayerPyHuanyuan.fadeOut();
            oLayerPyHuanyuanOrNot.fadeIn();
        });
        return newItem;
    },
    renderPyHuanyuanList:function(){
        var _this = this;
        var _wishData = _this.wishData;
        var oLayerPyHuanyuan = $(".layer-py-huanyuan");
        var oLayerPyHuanyuanOrNot = $(".layer-py-huanyuan-or-not");
        var oHuanyuanList = $(".layer-py-huanyuan ul");
        var oPyHuanyuanConfirm = $(".py-huanyuan-confirm");
        var oPyHuanyuanCancel = $(".py-huanyuan-cancel");
        if(_this.wishData.length === 0){
            oHuanyuanList.html("<li>暂无许愿信息</li>");
        }else{
            for(var i = 0,len = _wishData.length;i < len;i ++){
                oHuanyuanList.prepend(_this.createWishItem(_wishData[i]));
            }
        }
        oPyHuanyuanConfirm.bind("click",function(){
            _this.oLayerBlock.fadeOut();
            oLayerPyHuanyuanOrNot.fadeOut();
            _this.slideToFo();
            $(".tribute-confirm-submit").removeClass("tribute-py-shangxiang").addClass("tribute-py-huanyuan");
        });
        oPyHuanyuanCancel.bind("click",function(){
            _this.oLayerBlock.fadeOut();
            oLayerPyHuanyuanOrNot.fadeOut();
        });
    },
    renderGlow:function(){
        var canvas = document.getElementById("layer-glow"),
            ctx = canvas.getContext("2d");
        var imgs = [];

        for(var i = 1;i < 4;i++){
            var img = document.createElement("img");
            img.src = "./assets/images/aburnjoss/glow/faguang"+i+".png";
            imgs.push(img);
        }
        var glowing = function(img){
            ctx.clearRect(0,0,600,265);
            ctx.drawImage(img,0,0);
        }

        var _interval;
        this.startGlow = function(){
            document.getElementById("layer-glow-container").style.display = "block";
            var n = 0;
            _interval = setInterval(function(){
                glowing(imgs[n]);
                n = n > 1?0:n + 1;
            },1000/4);
        };

        this.stopGlow = function(){
            document.getElementById("layer-glow-container").style.display = "none";
            clearInterval(_interval);
        };
    },
    initData:function(){
        var _this = this;
        _this.oTributeAmount = $(".tribute-confirm-submit p");
        _this.foSampleList = {
            "fo1_guanshiyin" :{}
        };
        _this.foCompleteList = [];
        _this.nCurrentFoId = 1;
        _this.sCurrentFoName = "观音菩萨";

        _this.renderPyHuanyuanList();
        dataController.initBj(function(res){
            console.log(res);

            for(var i = 0,len = res.wish_list.length;i < len;i++){
                var _wishList = res.wish_list[i];
                _this.wishData.push({
                    "id":_wishList.id,
                    "foId":_wishList.foid,
                    "foName":_wishList.foname,
                    "foContent":_wishList.wish
                })
            }
            _this.renderPyHuanyuanList();

            for(var x = 0,xlen = res.bj_list.length;x < xlen;x++){
                var _bjList = res.bj_list[x];
                var _foId = parseInt(_bjList.foid) - 1;
                var _gpIds = _bjList.gp_ids.split(",");
                _this.foCompleteList.push($(".fo-lists li").eq(_foId).attr("data-fo"));
                _this.sCurrentFo = $(".fo-lists li").eq(_foId).attr("data-fo");
                _this.foSampleList[_this.sCurrentFo] = {};
                for(var j = 0,jlen = _gpIds.length;j < jlen;j++){
                    if(_gpIds[j]){
                        var arrIndex = _gpIds[j].split("|"),
                            sTypeId = arrIndex[0],
                            sId = arrIndex[1];
                        _this.insertElm(Tributes[parseInt(sTypeId)-1].children[parseInt(sId)-1],"type"+sTypeId,sId,_gpIds[j]);
                    }
                }
            }
            _this.setCurrentState();
        });
    },
    start:function(){
        this.initData();
        this.foCarousel();
        this.renderTribute();
        this.renderGlow();
        this.tributeSwitch();
        this.onPyHuanyuan();
        this.onOpenMeritBox();
        this.onDrawPot();
        this.onConfirmTributes();
        this.onConfirmMeritBox();
    }
};

ABurnjoss.start();